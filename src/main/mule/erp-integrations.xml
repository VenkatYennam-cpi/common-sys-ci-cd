<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:compression="http://www.mulesoft.org/schema/mule/compression" xmlns:wsc="http://www.mulesoft.org/schema/mule/wsc" xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:file="http://www.mulesoft.org/schema/mule/file" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd 
http://www.mulesoft.org/schema/mule/file http://www.mulesoft.org/schema/mule/file/current/mule-file.xsd 
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/wsc http://www.mulesoft.org/schema/mule/wsc/current/mule-wsc.xsd
http://www.mulesoft.org/schema/mule/compression http://www.mulesoft.org/schema/mule/compression/current/mule-compression.xsd">

	<sub-flow name="sf-ns-ospc-integration-flow" doc:id="2159cc5d-81da-40fb-b3da-9ac0436df18d">
		<logger level="INFO" doc:name="sf-ns-ospc-integration-flow Begin" doc:id="cafeb3db-ea6e-4c92-82b4-a464eda5e9f4" message="sf-ns-ospc-integration-flow Begin" />
		<ee:transform doc:name="Transform OSPC Inbound request Message" doc:id="893456d2-a9bd-48d6-9ab6-097cc81e5514">
			<ee:message>
				<ee:set-payload resource="dwScripts/p-post-ospc-inbound-request.dwl" />
			</ee:message>
		</ee:transform>
		<logger level="DEBUG" category="DEBUG" message="OSPC Inbound Request Payload is::::#[payload]" doc:name="Log OSPC Inbound Request Payload" />
		<http:request method="POST" doc:name="HTTP_Request_configuration_OSPC" config-ref="HTTP_Request_configuration_OSPC" path="fscmRestApi/resources/11.13.18.05/erpintegrations"
			doc:id="4f68580b-80ca-4262-89e0-bf9646c39983" />
		<logger level="DEBUG" category="DEBUG" message="OSPC Inbound Response Payload is::::#[payload]" doc:name="Log OSPC Inbound Response Payload" />
		<ee:transform doc:name="Transform OSPC Inbound request Message" doc:id="8ee14601-67de-491b-88d3-ba046d06a52a">
			<ee:message>
				<ee:set-payload resource="dwScripts/p-post-ospc-inbound-response.dwl" />
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="sf-ns-ospc-integration-flow End" doc:id="7ee42e3c-669b-4c9e-9c89-95a1f27bf101" message="sf-ns-ospc-integration-flow End" />
	</sub-flow>

	<sub-flow name="sf-ns-ospc-jobexecutiondetails-flow" doc:id="43951352-e04a-4832-9789-771310f8793f">
		<logger level="INFO" doc:name="sf-ns-ospc-jobexecutiondetails-flow Begin" doc:id="61d3428a-b0e8-46e4-8dd1-331adde49369" message="sf-ns-ospc-jobexecutiondetails-flow Begin" />
		<set-variable variableName="requestIdVar" value="#[attributes.uriParams.requestid]" doc:name="SV requestIdVar" />
		<ee:transform doc:name="Transform OSPC jobexecutiondetails request Message" doc:id="8d3a0c40-69c0-4d17-94e2-1fc66c68e3ab">
			<ee:message>
				<ee:set-payload resource="dwScripts/p-post-ospc-jobexecutiondetails-request.dwl" />
			</ee:message>
		</ee:transform>
		<logger level="DEBUG" category="DEBUG" message="OSPC jobexecutiondetails Request Payload is::::#[payload]" doc:name="Log OSPC jobexecutiondetails Request Payload" />
		<http:request method="POST" doc:name="HTTP_Request_configuration_OSPC" config-ref="HTTP_Request_configuration_OSPC" path="${ospc.path}" doc:id="1f68bd7d-19e3-42c2-80eb-b2d4c14b26f1" />
		<ee:transform doc:name="Transform to store jobexecutiondetails in variable" doc:id="727244dd-d7ea-4b4f-ba9f-de4f979593da">
			<ee:variables>
				<ee:set-variable variableName="jobexecutiondetailsVar" resource="dwScripts/v-post-ospc-jobexecutiondetails-response.dwl" doc:name="SV jobexecutiondetailsVar" />
			</ee:variables>
		</ee:transform>
		<choice doc:name="CEHCK IF Payload is not null" doc:id="6ae6b045-de6e-4c80-a2cb-5e5331fd6207">
			<when expression="#[payload.DocumentContent != null]">
				<flow-ref doc:name="sf-ospc-job-status-flow" doc:id="d33e896e-b57e-47ad-a467-c28e04f312e9" name="sf-ospc-job-status-flow" target="parentIdStatusVar" />
				<choice doc:name="CEHCK IF status is SUCCEEDED" doc:id="7765feda-cd1a-4496-a49e-4bc8fded3438">
					<when expression="#[vars.parentIdStatusVar.RequestStatus == 'SUCCEEDED']">
						<ee:transform doc:name="Transform to decode the base64 response" doc:id="1314d830-5806-417c-b30e-0559807c2a57">
							<ee:message>
								<ee:set-payload resource="dwScripts/p-ospc-decode-response.dwl" />
							</ee:message>
						</ee:transform>
						<compression:extract doc:name="Extract OSPC Jobexecutiondetails Response">
							<compression:extractor>
								<compression:zip-extractor />
							</compression:extractor>
						</compression:extract>
						<ee:transform doc:name="Set requestIdaccumulatorVar" doc:id="bc177687-6edd-4d0e-95c3-d1df4d5d38c9">
							<ee:variables>
								<ee:set-variable variableName="requestIdaccumulatorVar"><![CDATA[%dw 2.0
					output application/java
					---
					[]]]>
								</ee:set-variable>
							</ee:variables>
						</ee:transform>
						<logger level="DEBUG" category="DEBUG" doc:name="Log Extracted RequestIds" message="Extracted RequestIds are:::#[output application/json --- ((((payload pluck $$) joinBy '|') replace '.log' with '') splitBy '|')]" />

						<foreach doc:name="For Each Request Id's" counterVariableName="ctr" doc:id="a9957228-0aad-4211-b01e-430f88883fa8"
							collection="#[output application/json --- ((((payload pluck $$) joinBy '|') replace '.log' with '') splitBy '|')]">
							<set-variable value="#[payload]" variableName="requestIdVar" doc:name="SV requestIdVar" />
							<flow-ref doc:name="sf-ospc-job-status-flow" doc:id="81faa6f0-0006-438b-be59-a5ba7d17af8a" name="sf-ospc-job-status-flow" />
							<ee:transform doc:name="Transform GET_FILE Response Payload Message" doc:id="05ac0385-4efb-4944-ac23-ecfb1d831e09">
								<ee:variables>
									<ee:set-variable variableName="requestIdaccumulatorVar" resource="dwScripts/v-requestid-accumulator.dwl" />
								</ee:variables>
							</ee:transform>
							<logger level="DEBUG" category="DEBUG" message="requestIdaccumulatorVar is::::#[vars.requestIdaccumulatorVar]" doc:name="Log requestIdaccumulatorVar" />
						</foreach>
						<ee:transform doc:name="Transform OSPC Inbound getESSJobStatus response Message" doc:id="dad5daa8-086f-4f2e-aa8e-6a09850441de">
							<ee:message>
								<ee:set-payload resource="dwScripts/p-post-ospc-get-essjobstatus-response.dwl" />
							</ee:message>
						</ee:transform>
					</when>
					<otherwise>
						<ee:transform doc:name="Transform OSPC Inbound getESSJobStatus response Message" doc:id="cf7cadb9-17f4-4b5f-bf17-1daa69f498fd">
							<ee:message>
								<ee:set-payload resource="dwScripts/p-ospc-get-parent-essjobstatus-response.dwl" />
							</ee:message>
						</ee:transform>
					</otherwise>
				</choice>
			</when>
			<otherwise>
				<set-variable value='#["Invalid Data"]' doc:name="Set Error Description" doc:id="b14d21d8-b804-4bbc-b926-da14eac155c9" variableName="errorDescription" />
				<ee:transform doc:id="5660ff73-baf7-43f2-86e9-7772b6c3a0ab" doc:name="Error Response">
					<ee:message>
						<ee:set-payload resource="dwScripts/errorResponse400.dwl" />
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="httpStatus"><![CDATA[400]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
			</otherwise>
		</choice>
		<logger level="INFO" doc:name="sf-ns-ospc-jobexecutiondetails-flow End" doc:id="d3ba56a8-acca-473e-b88c-4531b7fa8821" message="sf-ns-ospc-jobexecutiondetails-flow End" />
	</sub-flow>

	<sub-flow name="sf-ospc-job-status-flow" doc:id="2a3f2ec3-c82b-4a13-83df-1df0a74bfb52">
		<ee:transform doc:name="Transform OSPC EssJob Status for parentId" doc:id="1f2b2fd4-080e-4410-b438-88a314c79781">
			<ee:message>
				<ee:set-payload resource="dwScripts/p-post-ospc-get-essjobstatus-request.dwl" />
			</ee:message>
		</ee:transform>
		<http:request method="POST" doc:name="HTTP_Request_configuration_OSPC" config-ref="HTTP_Request_configuration_OSPC" path="${ospc.path}" doc:id="5332a349-c080-4a5f-8333-44b98895b75d" />
		<logger level="DEBUG" category="DEBUG" message="OSPC getESSJobStatus Response RequestId is::::#[payload.ReqstId]:::::Status is::::#[payload.RequestStatus]" doc:name="Log OSPC getESSJobStatus Response Payload" />
	</sub-flow>

	<sub-flow name="sf-ospc-ns-searchresults-flow" doc:id="b5166fcc-ffbe-4658-850a-9705e57f13d7">
		<logger level="INFO" doc:name="sf-ospc-ns-searchresults-flow Begin" doc:id="ef11d574-b5ee-40e7-b038-325e493bdba5" message="sf-ospc-ns-searchresults-flow Begin" />
		<set-variable value="#[attributes.queryParams.q]" variableName="queryTextVar" mimeType="application/json" doc:name="SV queryTextVar" />
		<ee:transform doc:name="Transform getSearchResult Request Message" doc:id="bb5eb6a6-2baf-4262-a8e9-ecb1087cc774">
			<ee:message>
				<ee:set-payload resource="dwScripts/p-ospc-outbound-get-search-result-request.dwl" />
			</ee:message>
		</ee:transform>
		<logger level="DEBUG" category="DEBUG" message="GET_SEARCH_RESULTS Request Payload is::::#[payload]" doc:name="Log GET_SEARCH_RESULTS Request Payload" />
		<flow-ref doc:name="OSPC_Consumer_Config_Service" doc:id="486fcbbe-e451-4ebf-bb9e-6f343a09778f" name="cf-ospc-web-consumer-service" />
		<ee:transform doc:name="Transform getSearchResult Response Message" doc:id="6684c493-5f20-472f-b784-c3c3e455cc7f">
			<ee:message>
				<ee:set-payload resource="dwScripts/p-ospc-outbound-get-search-result-response.dwl" />
			</ee:message>
		</ee:transform>

		<logger level="INFO" doc:name="sf-ospc-ns-searchresults-flow End" doc:id="39903bb4-7783-438b-b914-b3cdb4dd5575" message="sf-ospc-ns-searchresults-flow End" />
	</sub-flow>

	<sub-flow name="sf-ospc-ns-update-document-flow" doc:id="4e64f11d-f94c-4442-bf50-430cf51824a6">
		<logger level="INFO" doc:name="mf-ospc-ns-update-document-flow Begin" doc:id="7ff40ff6-04e7-4411-97ce-31d248cf69a3" message="mf-ospc-ns-update-document-flow Begin" />
		<ee:transform doc:name="Transform OSPC Inbound UpdateFile Request Message" doc:id="ecb76113-8e17-433f-b27c-ef5fe8137aca">
			<ee:message>
				<ee:set-payload resource="dwScripts/p-ospc-update-doc-info-request.dwl" />
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="id"><![CDATA[%dw 2.0
					output application/java
					---
					payload]]>
				</ee:set-variable>
			</ee:variables>
		</ee:transform>
		<logger level="DEBUG" category="DEBUG" message="UPDATE_DOCINFO Request Payload is::::#[payload]" doc:name="Log UPDATE_DOCINFO Request Payload" />
		<flow-ref doc:name="OSPC_Consumer_Config_Service" doc:id="e5b31b64-cb49-4aa1-9170-7caf866d8903" name="cf-ospc-web-consumer-service" />
		<logger level="DEBUG" category="DEBUG" message="UPDATE_DOCINFO Response Payload is::::#[payload]" doc:name="Log UPDATE_DOCINFO Response Payload" />
		<choice doc:name="CHECK IF StatusCode is not null" doc:id="897b1949-c80b-4d00-ab59-4b2ba1dc5e7a">
			<when expression='#[%dw 2.0 output application/java --- (payload.Body.GenericResponse.Service.Document.*Field[?($.@name == "StatusCode")][0]) != null]'>
				<set-variable value='#[%dw 2.0 output application/java --- (payload.Body.GenericResponse.Service.Document.*Field[?($.@name == "StatusMessage")][0])]' doc:name="Set Error Description"
					doc:id="ef635f95-0d1e-428b-a3fb-337432e12b19" variableName="errorDescription" />
				<ee:transform doc:id="38717c6b-edec-44a7-81f8-a8ca29cb0d2a" doc:name="DW ErrorResponse request">
					<ee:message>
						<ee:set-payload resource="dwScripts/errorResponse400.dwl" />
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="httpStatus"><![CDATA[400]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
			</when>
			<otherwise>
				<logger level="INFO" message="Data successfully updated" doc:name="Log Data successfully updated" />
			</otherwise>
		</choice>
		<logger level="INFO" doc:name="mf-ospc-ns-update-document-flow End" doc:id="2d814e19-002f-4114-a9b6-61eab1d05d28" message="mf-ospc-ns-update-document-flow End" />
	</sub-flow>

	<sub-flow name="sf-ospc-ns-documents-flow" doc:id="bfc16bf1-32e3-48d5-861b-3b1a7d14e69f">
		<logger level="INFO" doc:name="sf-ospc-ns-documents-flow Begin" doc:id="cb2b6321-f4b2-4ee8-9115-128bafe66ad6" message="sf-ospc-ns-documents-flow Begin" />
		<ee:transform doc:name="Set accumulatorVar" doc:id="e8a6d0d1-8a67-49bd-bf2b-d5b71ebb3374">
			<ee:variables>
				<ee:set-variable variableName="accumulatorVar"><![CDATA[%dw 2.0
					output application/java
					---
					[]]]>
				</ee:set-variable>
			</ee:variables>
		</ee:transform>
		<foreach doc:name="For Each Id" counterVariableName="ctr" doc:id="fccee6f7-8f66-4188-a4a5-0fbd63a62f11"
			collection='#[%dw 2.0 output application/java --- (attributes.queryParams.ids) splitBy ","]'>
			<ee:transform doc:name="Transform OSPC outbound GetFile Request Message" doc:id="91a43224-9629-4580-a556-34f4a77f00de">
				<ee:message>
					<ee:set-payload resource="dwScripts/p-ospc-outbound-get-file-request.dwl" />
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="id"><![CDATA[%dw 2.0
					output application/java
					---
					payload]]>
					</ee:set-variable>
				</ee:variables>
			</ee:transform>
			<logger level="DEBUG" category="DEBUG" message="GET_FILE Request Payload is::::#[payload]" doc:name="Log GET_FILE Request Payload" />
			<flow-ref doc:name="OSPC_Consumer_Config_Service" doc:id="036aa219-ad00-4f23-bc21-327db415c777" name="cf-ospc-web-consumer-service" />
			<logger level="DEBUG" category="DEBUG" message="GET_FILE Response Payload is::::#[payload]" doc:name="Log GET_FILE Response Payload" />
			<ee:transform doc:name="Transform GET_FILE Response Payload Message" doc:id="9a2480a0-4e1a-4251-bf2c-5b151b20a2a4">
				<ee:variables>
					<ee:set-variable variableName="accumulatorVar" resource="dwScripts/v-accumulator.dwl" />
				</ee:variables>
			</ee:transform>
		</foreach>
		<set-payload value="#[vars.accumulatorVar]" mimeType="application/json" doc:name="SP accumulatorVar" />
		<logger level="INFO" doc:name="sf-ospc-ns-documents-flow End" doc:id="807ee0d8-bd7b-43d6-852a-d319bca7de1a" message="sf-ospc-ns-documents-flow End" />
	</sub-flow>



</mule>
